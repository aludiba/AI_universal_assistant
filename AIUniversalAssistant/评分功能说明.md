# 评分功能说明

## 功能概述

应用已集成智能评分功能，包括：
1. **手动评分入口**：设置页面中的"前往评分"按钮（保留原有功能）
2. **智能随机评分提示**：在用户使用过程中自动弹出评分请求

## 实现位置

### 1. 核心功能封装
所有评分相关功能已封装在 `AIUAToolsManager` 中：

#### 头文件 (`AIUAToolsManager.h`)
```objc
// 前往App Store评分
+ (void)rateApp;

// 随机弹出评分提示（根据使用次数智能判断）
+ (void)tryShowRandomRatingPrompt;

// 检查是否应该显示评分提示
+ (BOOL)shouldShowRatingPrompt;

// 增加应用启动次数（在AppDelegate中调用）
+ (void)incrementLaunchCount;

// 记录用户拒绝评分
+ (void)userDeclinedRating;
```

### 2. 触发时机

#### 应用启动时
在 `AppDelegate.m` 的 `didFinishLaunchingWithOptions` 方法中：
```objc
// 记录应用启动次数
[AIUAToolsManager incrementLaunchCount];
```

#### 应用激活时
在 `AppDelegate.m` 的 `applicationDidBecomeActive` 方法中：
```objc
// 随机触发评分提示（延迟2秒，避免打扰用户）
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
    [AIUAToolsManager tryShowRandomRatingPrompt];
});
```

#### 完成写作后
在 `AIUAWritingDetailViewController.m` 的 `writingCompletedWithContent` 方法中：
```objc
// 随机触发评分提示（写作完成是一个好时机）
[AIUAToolsManager tryShowRandomRatingPrompt];
```

#### 文档编辑完成后
在 `AIUADocDetailViewController.m` 的AI生成完成回调中：
```objc
// 随机触发评分提示（文档编辑完成是一个好时机）
[AIUAToolsManager tryShowRandomRatingPrompt];
```

## 评分策略

### 触发条件
系统会智能判断是否应该显示评分提示，条件如下：

1. **启动次数 ≥ 5次**
2. **使用次数 ≥ 10次**
3. **距离上次提示 ≥ 7天**（普通情况）
4. **距离上次提示 ≥ 30天**（用户拒绝评分后）
5. **30%的随机概率**（避免过于频繁）

### 用户状态记录
使用 `NSUserDefaults` 保存以下数据：
- `AIUAAppLaunchCount`：应用启动次数
- `AIUAAppUsageCount`：功能使用次数
- `AIUALastRatingPromptDate`：上次评分提示日期
- `AIUAUserHasRated`：用户是否已评分
- `AIUAUserDeclinedRating`：用户是否拒绝评分

### 避免打扰策略
1. **用户已评分**：不再显示评分提示
2. **拒绝后冷却**：用户拒绝后30天内不再提示
3. **频率限制**：7天内最多提示一次
4. **随机性**：只有30%的概率触发，避免每次都弹出

## 配置说明

### App Store ID 配置
在上架后，需要在 `Info.plist` 中配置 App Store ID：
```xml
<key>AppStoreID</key>
<string>YOUR_ACTUAL_APP_STORE_ID</string>
```

### 手动评分入口
设置页面中的"前往评分"按钮已更新为使用统一的评分方法：
```objc
- (void)rateApp {
    NSLog(@"[设置] 用户点击前往评分");
    // 使用AIUAToolsManager的统一评分方法
    [AIUAToolsManager rateApp];
}
```

## 测试建议

### 测试评分弹窗
1. 启动应用5次以上
2. 完成写作或文档编辑操作10次以上
3. 观察控制台日志，查看评分条件判断
4. 如果满足条件且命中随机概率，会弹出系统评分对话框

### 查看日志
所有评分相关操作都有详细的日志输出：
```
[评分] 启动次数: 5
[评分] 使用次数: 10
[评分] 满足评分条件 - 启动次数:5, 使用次数:10
[评分] 随机触发评分提示
[评分] 调用系统评分弹窗
```

## 注意事项

1. **系统限制**：iOS 系统对 `SKStoreReviewController` 有使用限制，一年最多显示3次
2. **测试环境**：在开发和测试环境中，系统可能不会真正显示评分对话框
3. **用户体验**：评分提示应该在用户完成积极操作后显示，而不是在失败或错误时
4. **App Store ID**：上架前务必配置正确的 App Store ID

## 扩展建议

如需在其他场景触发评分，只需在合适的位置调用：
```objc
[AIUAToolsManager tryShowRandomRatingPrompt];
```

例如：
- 用户购买VIP后
- 用户分享内容后
- 用户连续使用N天后
- 用户完成特定任务后

