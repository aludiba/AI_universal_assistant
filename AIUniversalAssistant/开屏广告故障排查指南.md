# 开屏广告故障排查指南

## 📱 你的情况

### 当前状态
- ✅ SDK已安装（Ads-CN 6.7.0.8）
- ✅ 代码已配置（AppID: 5755016）
- ❌ 真机运行时广告未显示
- ⚠️ 只看到网络连接警告，没有穿山甲日志

## 🔍 故障排查步骤

### 步骤1: 检查详细日志

重新运行应用，在Xcode控制台查找以下关键日志：

```
========== 应用启动开始 ==========
[启动] 越狱检测通过
[启动] IAP管理器初始化完成
[穿山甲] 开始初始化SDK，AppID: xxx
[穿山甲] SDK初始化成功
[启动] 广告开关: 1
[启动] 是否应展示开屏广告: 1
========== 开屏广告流程开始 ==========
[穿山甲] AppID: xxx
[穿山甲] 代码位ID: xxx
```

#### ✅ 如果看到上述日志
说明SDK初始化成功，继续查看广告加载日志：
- `✅ [穿山甲] 开屏广告加载完成` - 广告加载成功
- `❌ [穿山甲] 开屏广告加载失败` - 查看错误详情

#### ❌ 如果看不到穿山甲日志
可能原因：
1. SDK未正确链接
2. 头文件未引入
3. 宏定义未生效

### 步骤2: 验证SDK是否正确链接

在 `AppDelegate.m` 文件开头，检查：

```objective-c
#if __has_include(<BUAdSDK/BUAdSDK.h>)
#import <BUAdSDK/BUAdSDK.h>
#define HAS_PANGLE_SDK 1  // 这个应该是1
#else
#define HAS_PANGLE_SDK 0  // 如果是0说明SDK未找到
#endif
```

**验证方法**：
在 `initPangleSDK` 方法开头添加：
```objective-c
NSLog(@"HAS_PANGLE_SDK = %d", HAS_PANGLE_SDK);
```

- 如果输出 `1` - SDK已正确链接
- 如果输出 `0` - SDK未链接，需要重新安装

### 步骤3: 检查配置是否正确

在日志中查找：
```
[穿山甲] AppID: 5755016
[穿山甲] 代码位ID: 893331808
```

确认：
- ✅ AppID 不为空
- ✅ 代码位ID 不为空
- ✅ 这些是在穿山甲平台申请的正式ID

### 步骤4: 检查网络权限

#### iOS 14+ ATT权限（重要！）

开屏广告需要跟踪权限。在 `Info.plist` 中确认已添加：
```xml
<key>NSUserTrackingUsageDescription</key>
<string>为了向您提供更好的广告体验，请允许应用跟踪您的活动</string>
```

**验证方法**：
首次启动时，应该弹出权限请求对话框：
```
"AI写作喵"想要跟踪您在其他公司的 App 和网站中的活动
```

如果没有弹出，说明：
1. 设备系统设置中禁止了所有APP跟踪
2. Info.plist配置未生效

**检查设备设置**：
```
设置 → 隐私与安全性 → 跟踪 → 允许App请求跟踪
```
确保此开关是打开的。

### 步骤5: 检查网络连接

你的日志显示大量网络连接警告：
```
nw_connection_copy_connected_local_endpoint_block_invoke
nw_connection_copy_connected_remote_endpoint_block_invoke
```

**可能原因**：
1. 设备网络不稳定
2. 广告服务器连接失败
3. 防火墙或VPN拦截

**解决方案**：
- 确保设备已连接互联网（4G/5G或Wi-Fi）
- 关闭VPN
- 尝试切换网络环境

### 步骤6: 验证真机测试环境

#### 测试代码位
穿山甲提供了测试代码位，先用测试代码位验证：

```objective-c
// 在 AIUAConfigID.h 中临时替换
#define AIUA_APPID               @"5001121"      // 测试AppID
#define AIUA_SPLASH_AD_SLOT_ID   @"887382973"   // 测试代码位
```

如果测试代码位能展示广告，说明：
- ✅ SDK集成正确
- ❌ 你的AppID或代码位可能有问题

如果测试代码位也不展示，说明：
- ❌ SDK集成或配置有问题

### 步骤7: 检查穿山甲账号状态

登录穿山甲平台：https://www.csjplatform.com/

检查：
1. **应用状态**：应用是否审核通过
2. **代码位状态**：代码位是否已激活
3. **填充率**：是否有广告填充
4. **余额**：账户是否有余额

**常见问题**：
- 新创建的应用/代码位需要审核（可能需要1-3天）
- 测试期间广告填充率可能较低
- 部分地区或时段可能无广告

## 🛠️ 快速诊断命令

### 命令1: 验证SDK版本
```bash
cd Pods/Ads-CN
ls -la
# 应该看到版本号：6.7.0.8
```

### 命令2: 检查Framework
```bash
cd Pods/BUTTSDKFramework
ls -la
# 应该看到 TTSDKCore.framework 等文件
```

### 命令3: 清理重新编译
```bash
# 在Xcode中
Cmd + Shift + K  # Clean Build Folder
Cmd + B          # Build
Cmd + R          # Run
```

## 📊 常见错误及解决方案

### 错误1: 无任何日志输出
**问题**：代码运行但没有任何穿山甲相关日志

**原因**：
- SDK未正确链接
- workspace打开方式错误

**解决方案**：
```bash
# 1. 重新安装依赖
cd /path/to/project
rm -rf Pods Podfile.lock
pod install

# 2. 确保打开 .xcworkspace
open AIUniversalAssistant.xcworkspace
```

### 错误2: SDK初始化失败
**日志**：`❌ [穿山甲] SDK初始化失败: xxx`

**原因**：
- AppID不正确
- 网络问题
- 证书问题

**解决方案**：
1. 检查AppID是否正确
2. 检查网络连接
3. 尝试使用测试AppID

### 错误3: 广告加载失败 - 错误码1009
**日志**：`❌ 错误码: 1009`

**原因**：设备网络断开

**解决方案**：
- 检查设备网络连接
- 确保已连接到互联网

### 错误4: 广告加载失败 - 错误码20001
**日志**：`❌ 错误码: 20001`

**原因**：无广告填充

**解决方案**：
- 正常现象，等待一段时间后重试
- 尝试更换网络环境
- 联系穿山甲客服确认账号状态

### 错误5: 广告加载失败 - 错误码40002
**日志**：`❌ 错误码: 40002`

**原因**：代码位ID不正确或未激活

**解决方案**：
- 检查代码位ID是否正确
- 在穿山甲平台确认代码位已激活
- 确认代码位类型为"开屏广告"

## 🎯 推荐的调试流程

### 第一步：基础验证
```
1. 确认 HAS_PANGLE_SDK = 1
2. 确认 AppID 和代码位ID已配置
3. 确认网络连接正常
```

### 第二步：权限验证
```
1. 检查 Info.plist 权限配置
2. 检查设备"跟踪"权限开关
3. 首次运行应该弹出权限请求
```

### 第三步：测试代码位验证
```
1. 使用穿山甲测试代码位
2. 观察是否能展示测试广告
3. 确认SDK集成是否正确
```

### 第四步：真实代码位验证
```
1. 替换为真实AppID和代码位
2. 确认穿山甲平台状态
3. 等待广告填充（可能需要一些时间）
```

## 📞 获取帮助

如果以上步骤都无法解决问题：

1. **收集完整日志**
   ```
   从应用启动到广告失败的完整控制台输出
   ```

2. **记录关键信息**
   ```
   - SDK版本
   - iOS版本
   - 设备型号
   - 网络环境
   - AppID和代码位ID
   - 错误码和错误信息
   ```

3. **联系技术支持**
   - 穿山甲官方：https://www.csjplatform.com/supportcenter
   - 开发者社区：https://forum.partner.oceanengine.com/

## ✅ 成功的标志

当一切正常时，你应该看到：

```
========== 应用启动开始 ==========
[启动] 越狱检测通过
[启动] IAP管理器初始化完成
[穿山甲] 开始初始化SDK，AppID: 5755016
[穿山甲] SDK初始化成功
[启动] 主窗口创建完成
[启动] 广告开关: 1
[启动] 是否应展示开屏广告: 1
[启动] 准备展示开屏广告
========== 开屏广告流程开始 ==========
[穿山甲] 准备展示开屏广告
[穿山甲] 窗口对象: <UIWindow: 0x...>
[穿山甲] AppID: 5755016
[穿山甲] 代码位ID: 893331808
[穿山甲] 开始加载开屏广告，代码位ID: 893331808
✅ [穿山甲] 开屏广告加载成功
✅ [穿山甲] 开屏广告已展示
✅ [穿山甲] 开屏广告关闭，类型: 1
[主界面] 已展示
```

现在重新运行，看看日志输出！

